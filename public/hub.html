<!doctype html>
<html>

<head>
    <title>Socratik</title>
    <link rel="stylesheet" href="css/main.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ"
        crossorigin="anonymous">
</head>

<body class="fullheight">
    <nav class="navbar navbar-toggleable-md navbar-light bg-faded">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        <a class="navbar-brand" href="#">Socratik</a>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a href="#">Home</a>
                </li>
                &nbsp;&nbsp;&nbsp;
                <li class="nav-item">
                    <a href="about.html">About</a>
                </li>
                &nbsp;&nbsp;&nbsp;
                <li class="nav-item">
                    <a href="groups.html">My Groups</a>
                </li>
            </ul>

        </div>
        <ul class="navbar-nav mr-right">
            <li class="nav-item active">
                <button id="adduser" class="btn btn-primary">+ Add User</button>
            </li>
        </ul>
    </nav>

    <div class="fullheight">
        <div class="row fullheight">
            <!--Sidebar-->
            <div class="col-md-3 fullheight">
                <div class="card fullheight" style="margin: 10px; height:90%;">
<br>
<table id="questions">
    <tbody id="qbody">
        <tr class="qrow">
            <td class="text-center">
                <h2 class="questiontitle" href="#">Questions</h2>

            </td>
            <td><button class="btn btn-default" id="newquestion">+</button></td>
        </tr>
        <tr class="qrow">
            <td><a class="question" href="#">Was Huckleberry Finn a real book?</a></td>
        </tr>
        <tr class="qrow">
            <td><a class="question" href="#">Was Huckleberry Finn a real book?</a></td>
        </tr>
        <tr class="qrow">
            <td><a class="question" href="#">Was Huckleberry Finn a real book?</a></td>
        </tr>
        <tr class="qrow">
            <td><a class="question" href="#">Was Huckleberry Finn a real book?</a></td>
        </tr>
        <tr class="qrow">
            <td><a class="question" href="#">Was Huckleberry Finn a real book?</a></td>
        </tr>
    </tbody>
</table>
</div>
</div>
<!--Main Page-->
<div class="col-md-9 col-md-offset-1" id="scrollingpanel" style="padding: 10px 30px 0px 0px;">
<div class="card" style="width:100%">
<div class="row" style="height:80px; padding-left: 10px;" id="users">
<!--                        Online users-->
<div class="user">
    <img src="/css/personIcon.png">
    <p>Jim bob</p>
</div>
<div class="user" style="margin: 0px 5px;">
<img src="/css/personIcon.png">
<p>John Smith</p>
</div>
<div class="user" style="margin: 0px 5px;">
<img src="/css/personIcon.png">
<p>Your Boi</p>
</div>

</div>
</div>
<br>
<div class="card" style="padding:15px; margin-bottom:0px;">
<div class="row">
    <div class="col-md-12">
        <h1 id="questionstatement"></h1>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <p id="qbody" class="questionbody"></p>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <p id="qdetails" class="details"></p>
    </div>
</div>
</div>
    
</br><div class="card" style="margin-bottom: 200px;">
    <table id="answertable"  style="padding:5px;">
        <tbody>
        </tbody>
    </table>
<!--</div>-->

</div>
</div>
<div id="dialog">
    <textarea id="comment" rows="2" type="text" class="form-control" placeholder="Comment"></textarea>
</div>
</div>
</div>
<br>
<img src="/css/personIcon.png" style="width:75px; height:75px; padding: 8px">
<img src="/css/personIcon.png" style="width:75px; height:75px; padding: 8px">
<img src="/css/personIcon.png" style="width:75px; height:75px; padding: 8px">
<br><br>
<div class="col-md-9 white" style="height:90vh;">

</div>
</body>

<style>
.mainbg {
    background-color: rgb(240, 240, 240);
}
.activeusers {
    height: 100px;
    border: 1px solid black;
}
.answer {
    padding: 1em;
    padding-bottom: 0;
}
.answerdetails {
    padding-left: 1em;
    color: grey;
}
.arow {
    border-bottom: 1px solid #ccc;
}
h1 {
    
}
h1, h2, h3 {
    font-family: Helvetica;
    font-weight: 200;
}
.questionbody {
    font-size: 1.4em;
}
.details {
    color: rgb(113, 113, 113);
}
.qrow {
    width: 100%;
    margin-bottom: 1em;
    height: 50px;
    border-bottom: 1px solid #ccc;
}

.qrow td {
    padding-left: 15px;
}

.question {
    width: 100%;
}
#questions {
    width: 100%;
}
.fullheight {
    height: 100%;
}
.container {
    margin-left: 0;
    margin-right: 0;
}
html, body {
    height: 100%;
}
.sidebar {
    background-color: rgba(255, 255, 255, 0.95);
}
.mainbg {
    background-color: lightblue;
    margin-right: 0;
}
#answers {
    background-color: white;
}

#answertable {
    width: 100%;
}

#dialog {
    width: 70%;
    margin-left:27%;
    padding: 10px;
    position: fixed;
/*    height: 100px;*/
    background-color: #ccc;
    box-shadow: 0px 0px 5px #888888;
    bottom: 0px;
}
</style>

<script src="/socket.io/socket.io.js"></script>
<script>
    var groupId;
    var questionId;
    var questions;
    var users;



    $(document).ready(function () {//call page with 

        var url = window.location.href;

        var splitURL = url.slice(url.indexOf("?")).split('&');
        if (splitURL.length >= 1) {
            groupId = splitURL[0].split('=')[1];

            if (splitURL.length >= 2) {
                questionId = splitURL[1].split('=')[1];
            } else {
                questionId = undefined;
            }

        } else {//Display first question in group
            //window.location.replace('/groups.html');
        }

        $.get("/api/v1/account/loggedin", function (data, status) {
            if (!data.success) {
                window.location.replace("index.html");
            }
        });

        $.post("/api/v1/group/groupID/info/".replace("groupID", groupId), {}, function (data, status) {
            if (data.success) {
                users = data.group.members;
            }
        });

        clearQuestions();
        getQuestions();

        $.post("/api/v1/group/" + groupId + "/questions", {}, function (data, status) {


            for (var i = 0; i < data.questions.length; ++i) {
                if (questionId === undefined) {
                    questionId = data.questions[0]._id;
                }
                if (data.questions[i]._id == questionId) {//Get group for users in here:

                    clearComments();
                    setQuestion(data.questions[i]);
                    for (var j = 0; j < data.questions[i].comments.length; ++j) {
                        addComment(data.questions[i].comments[j]);
                    }
                    break;
                }
            }
        });


        $('#adduser').click(function () {
            window.location.replace('adduser.html?groupId=' + groupId);
        });

    });

    function clearQuestions() {
        var header = `
        <tr class="qrow">
                                <td class="text-center">
                                    <h2 class="questiontitle" href="#">Questions</h2>
                                    
                                </td>
                                <td><button class="btn btn-primary" id="newquestion">+</button></td>
                            </tr>`;
        $('#qbody').html(header);

        $('#newquestion').click(function (e) {
            e.preventDefault();
            window.location.replace("/createquestion.html?groupId=" + groupId);
        });
    }

    function getQuestions() {//get and render questions
        $.post("/api/v1/group/" + groupId + "/questions", function (data, status) {
            for (var i = 0; i < data.questions.length; ++i) {
                addQuestion(data.questions[i]);
            }
        });
    }

    function addQuestion(q) {
        var question = `<tr class="qrow">
            <td><a class="question" href="hub.html?groupId=GROUPID&questionId=QID">QUESTION</a></td>
        </tr>`;

        question = question.replace("GROUPID", groupId).replace("QUESTION", q.question).replace("QID", q._id);
        $('#qbody').append(question);
    }

    function clearComments() {
        $('#answertable').html("");
    }

    function setQuestion(q) {
        $('#questionstatement').text(q.question);
        $('#qbody').text(q.desc);
        $('#qdetails').text('Posted by Bob Bobson at 23:00 on Saturday, January 14');
        for (var i = 0; i < q.comments.length; ++i) {
            addComment(q.comments[i]);
        }
    }

    function addComment(c) {
        var comment = `
        <tr class="arow">
                <td>
                    <div class="row">
                        <div class="col-md-12">
                            <p class="answer">ANSWERBODY</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <p class="answerdetails">Posted by POSTNAME on TIMEDATE</p>
                        </div>
                    </div>
                </td>
            </tr>`;
        var name = '';
        for (var i = 0; i < users.length; ++i) {
            if (users[i].id == c.userId) {
                name = users[i].firstname + ' ' + users[i].lastname;
                break;
            }
        }
        comment = comment.replace("ANSWERBODY", c.comment);
        comment = comment.replace("POSTNAME", name);
        var time = new Date(c.date);
        var opt = {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit"
        };
        var tstr = time.toLocaleTimeString("en-us", opt);
        comment = comment.replace("TIMEDATE", tstr);
        $('#answertable').first().append(comment);
    }


    var socket = io();

    //You are not logged in
    socket.on('logout', function () {
        window.location.replace('/index.html');
    });

    socket.on('init', function () {
        socket.emit('mygroup', questionId);
    });

    socket.on('message', function (data) {
        console.log('message received');
        addComment({
            comment: data.message,
            date: data.date,
            firstname: 'test',
            lastname: 'test'
        });
    });


    $('textarea').keyup(function (e) {
        if (e.keyCode == 13) { //enter key pressed
            var comment = $('#comment').val();
            $('#comment').val('');
            socket.emit('chat message', comment, questionId);
            //            addComment({
            //            comment: comment,
            //            date: Date.now(),
            //            firstName: 'test',
            //            lastname: 'test'
            //        });
        }
    });
</script>

</html>